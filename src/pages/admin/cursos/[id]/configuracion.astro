---
import DashboardLayout from '@layouts/DashboardLayout.astro'
import CourseDashboardHeader from '@components/admin/dashboard/CourseDashboardHeader.astro'
import SettingsTab from '@components/admin/dashboard/SettingsTab.svelte'
import { isAdmin } from '@lib/auth'
import { db } from '@db/index'
import { courses, enrollments } from '@db/schema'
import { eq, count } from 'drizzle-orm'

const user = Astro.locals.user
if (!user || !isAdmin(user)) return Astro.redirect('/login')

const { id } = Astro.params
if (!id) return Astro.redirect('/admin')

const [course] = await db.select().from(courses).where(eq(courses.id, id))
if (!course) return Astro.redirect('/admin')

// Fetch total count for header
const [totalRes] = await db
  .select({ value: count() })
  .from(enrollments)
  .where(eq(enrollments.courseId, id))
---

<DashboardLayout
  metadata={{
    title: `Administrar ${course.name} - Configuración`,
    description: 'Panel de administración del curso',
  }}
>
  <CourseDashboardHeader
    course={course}
    activeTab="settings"
    enrollmentTotal={totalRes.value}
  />

  <main>
    <SettingsTab client:load course={course} />
  </main>
</DashboardLayout>
