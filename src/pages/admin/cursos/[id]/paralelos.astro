---
import DashboardLayout from '@layouts/DashboardLayout.astro'
import CourseDashboardHeader from '@components/admin/dashboard/CourseDashboardHeader.astro'
import SectionsTab from '@components/admin/dashboard/SectionsTab.svelte'
import { isAdmin } from '@lib/auth'
import { db } from '@db/index'
import {
  courses,
  enrollments,
  users,
  sections,
  sectionDocentes,
} from '@db/schema'
import { eq, count } from 'drizzle-orm'

const user = Astro.locals.user
if (!user || !isAdmin(user)) return Astro.redirect('/login')

const { id } = Astro.params
if (!id) return Astro.redirect('/admin')

const [course] = await db.select().from(courses).where(eq(courses.id, id))
if (!course) return Astro.redirect('/admin')

// Fetch total count for header
const [totalRes] = await db
  .select({ value: count() })
  .from(enrollments)
  .where(eq(enrollments.courseId, id))

// Fetch sections
const rawSections = await db
  .select()
  .from(sections)
  .where(eq(sections.courseId, id))

// Fetch teachers for each section
const sectionsWithTeachers = await Promise.all(
  rawSections.map(async (section) => {
    const teachers = await db
      .select({
        id: users.id,
        discordUsername: users.discordUsername,
        name: users.name,
      })
      .from(sectionDocentes)
      .innerJoin(users, eq(sectionDocentes.teacherId, users.id))
      .where(eq(sectionDocentes.sectionId, section.id))

    return { ...section, docentes: teachers }
  }),
)

// Fetch all teachers for the dropdown
const teachersList = await db
  .select({
    id: users.id,
    discordUsername: users.discordUsername,
    name: users.name,
  })
  .from(users)
  .where(eq(users.role, 'docente'))

// Fetch student counts
const countsResult = await db
  .select({ sectionId: enrollments.sectionId, count: count() })
  .from(enrollments)
  .where(eq(enrollments.courseId, id))
  .groupBy(enrollments.sectionId)

const studentCounts: Record<string, number> = {}
countsResult.forEach((result) => {
  if (result.sectionId) studentCounts[result.sectionId] = result.count
})
---

<DashboardLayout
  metadata={{
    title: `Administrar ${course.name} - Paralelos`,
    description: 'Panel de administraciÃ³n del curso',
  }}
>
  <CourseDashboardHeader
    course={course}
    activeTab="sections"
    enrollmentTotal={totalRes.value}
  />

  <main>
    <SectionsTab
      client:load
      courseId={id}
      initialSections={sectionsWithTeachers}
      teachersList={teachersList}
      studentCounts={studentCounts}
    />
  </main>
</DashboardLayout>
