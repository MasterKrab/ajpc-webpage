---
import DashboardLayout from '@layouts/DashboardLayout.astro'
import CourseDashboard from '@components/admin/CourseDashboard.svelte'
import { isAdmin } from '@lib/auth'
import { db } from '@db/index'
import { courses, enrollments, users } from '@db/schema'
import { eq } from 'drizzle-orm'

const user = Astro.locals.user

if (!user || !isAdmin(user)) return Astro.redirect('/login')

const { id } = Astro.params
if (!id) return Astro.redirect('/admin')

const [course] = await db.select().from(courses).where(eq(courses.id, id))

if (!course) return Astro.redirect('/admin')

const enrollmentData = await db
  .select({
    enrollment: enrollments,
    courseName: courses.name,
    discordUsername: users.discordUsername,
  })
  .from(enrollments)
  .innerJoin(courses, eq(enrollments.courseId, courses.id))
  .innerJoin(users, eq(enrollments.userId, users.id))
  .where(eq(enrollments.courseId, id))
---

<DashboardLayout
  metadata={{
    title: `Administrar ${course.name}`,
    description: 'Panel de administraciÃ³n del curso',
  }}
>
  <CourseDashboard
    client:only
    course={course}
    initialEnrollments={enrollmentData}
    isSudo={user.role === 'sudo'}
  />
</DashboardLayout>
