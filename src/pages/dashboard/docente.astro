---
import DashboardLayout from '@layouts/DashboardLayout.astro'
import PanelNavigation from '@components/ui/PanelNavigation.astro'
import { isTeacher, isAdmin } from '@lib/auth'
import { db } from '@db/index'
import { sections, enrollments, courses, sectionDocentes } from '@db/schema'
import { eq, and, sql } from 'drizzle-orm'

const user = Astro.locals.user!
if (!isTeacher(user)) return Astro.redirect('/dashboard')

const isUserAdmin = isAdmin(user)

let query: any = db
  .select({
    id: sections.id,
    name: sections.name,
    courseId: sections.courseId,
    courseName: courses.name,
    studentCount: sql<number>`count(${enrollments.id})`.mapWith(Number),
  })
  .from(sections)
  .innerJoin(courses, eq(sections.courseId, courses.id))
  .leftJoin(
    enrollments,
    and(
      eq(sections.id, enrollments.sectionId),
      eq(enrollments.status, 'approved'),
    ),
  )
  .groupBy(sections.id, courses.name)

if (!isUserAdmin) {
  query = query
    .innerJoin(sectionDocentes, eq(sections.id, sectionDocentes.sectionId))
    .where(eq(sectionDocentes.teacherId, user.id))
}

const sectionsList = await query
---

<DashboardLayout
  metadata={{
    title: 'Panel de Docente',
    description: 'Panel de control para docentes de AJPC',
  }}
>
  <PanelNavigation
    title="Mis Paralelos ðŸ“š"
    tabs={[]}
    activeTab=""
    ariaLabel="Panel de docente"
  />

  {
    sectionsList.length === 0 ? (
      <div class="empty-state">
        <div class="empty-state__icon">ðŸ“š</div>
        <h2 class="empty-state__title">No tienes paralelos asignados</h2>
        <p class="empty-state__text">
          AÃºn no has sido asignado a ningÃºn paralelo. Contacta a un
          administrador.
        </p>
      </div>
    ) : (
      <div class="sections-grid">
        {sectionsList.map((section) => (
          <a
            href={`/dashboard/docente/${section.id}/modules`}
            class="section-card"
          >
            <div class="section-card__content">
              <h2 class="section-card__name">{section.name}</h2>
              <span class="section-card__course">{section.courseName}</span>
            </div>
            <div class="section-card__footer">
              <span class="student-count">
                {section.studentCount} Estudiantes
              </span>
              <span class="card-arrow" aria-hidden="true">
                â†’
              </span>
            </div>
          </a>
        ))}
      </div>
    )
  }
</DashboardLayout>

<style>
  .empty-state {
    padding: 6rem 2rem;
    text-align: center;
    background: var(--foreground-color);
    border-radius: 1.5rem;
    border: 1px solid var(--border-color);
  }

  .empty-state__icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  .empty-state__title {
    margin: 0 0 1rem;
    font-size: 1.75rem;
    font-weight: 800;
  }
  .empty-state__text {
    color: var(--text-color-secondary);
    max-width: 450px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .sections-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .section-card {
    display: flex;
    align-items: center;
    gap: 2rem;
    padding: 1.5rem 2rem;
    background: var(--foreground-color);
    border: 1px solid var(--border-color);
    border-left: 6px solid var(--brand-primary);
    border-radius: 1.25rem;
    text-decoration: none;
    box-shadow: var(--shadow-sm);
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .section-card:hover {
    transform: translateX(8px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
  }

  .section-card__content {
    flex: 1;
  }

  .section-card__name {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text-color-primary);
  }

  .section-card__course {
    display: block;
    color: var(--text-color-secondary);
    font-size: 1.05rem;
    font-weight: 500;
    margin-top: 0.25rem;
  }

  .section-card__footer {
    display: flex;
    align-items: center;
    gap: 2rem;
    padding-left: 2rem;
    border-left: 1px solid var(--border-color);
  }

  .student-count {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--brand-primary);
    background: rgba(var(--brand-primary-rgb), 0.1);
    padding: 0.4rem 0.8rem;
    border-radius: 0.75rem;
  }

  .card-arrow {
    font-size: 1.5rem;
    color: var(--brand-primary);
    opacity: 0;
    transform: translateX(-10px);
    transition: all 0.3s;
  }

  .section-card:hover .card-arrow {
    opacity: 1;
    transform: translateX(0);
  }
</style>
