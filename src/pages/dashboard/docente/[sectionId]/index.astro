---
import { isTeacher } from '@lib/auth'
import { db } from '@db/index'
import { sections, sectionDocentes } from '@db/schema'
import { eq } from 'drizzle-orm'
import { isAdmin } from '@lib/auth'

const user = Astro.locals.user!
if (!isTeacher(user)) return Astro.redirect('/dashboard')

const { sectionId } = Astro.params

// Validate access
const [section] = await db
  .select()
  .from(sections)
  .where(eq(sections.id, sectionId!))
if (!section) return Astro.redirect('/dashboard/docente')

if (!isAdmin(user)) {
  const [access] = await db
    .select()
    .from(sectionDocentes)
    .where(eq(sectionDocentes.sectionId, sectionId!))
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    .where(eq(sectionDocentes.teacherId, user.id) as any)
  if (!access) return Astro.redirect('/dashboard/docente')
}

return Astro.redirect(`/dashboard/docente/${sectionId}/modules`)
---
